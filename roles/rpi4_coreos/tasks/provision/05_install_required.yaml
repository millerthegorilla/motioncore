# ---
# - name: install required
#   hosts: all
#   gather_facts: false
#   remote_user: core
#   tasks:
#   - name: >-
#       Install needed packages using the raw module
#       *Takes a long time! (rpm-ostree install)*
#     ansible.builtin.raw: >-
#       sudo rpm-ostree install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-37.noarch.rpm 
#       python python3-libselinux && sudo reboot
- name: >-
   Install needed packages using the raw module
   *Takes a long time! (rpm-ostree install)*
  ansible.builtin.raw: >-
    sudo rpm-ostree --idempotent install "{{ rpmfusion_rpm_url }}"
    python python3-libselinux && sudo rpm-ostree db diff | grep Added: && sudo reboot &>/dev/null || exit 3
  register: oc
  #failed_when: "oc.rc in [ 1, 3 ]"
  delegate_to: "{{ rpi4_coreos_ip }}"
- debug: var=oc
- name: Wait for SSH to come up
  local_action: wait_for
                host="{{ rpi4_coreos_ip }}"
                port=22
                state=started
