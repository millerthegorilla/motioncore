---
- hosts: localhost
  gather_facts: false
  remote_user: core
  roles:
    - role: rpi4_coreos
    - role: get_set_ip
    - role: nordvpn
      vars:
        openvpn_auth_txt: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33333163336432366363383835363336396665306134336334326438666166306466393030323137
          3234383262373639613035303830613836653364393638310a653030633066646238656366613961
          39316134396564356135323562346266356539326439613831366138616434356139353339663831
          6635316534616334630a353739636662323166656434336164656432393837306337366235663861
          32383031323235656464623735363233306130623333386365316332646561353039616630303362
          36666561643233626539316466623935623133323238366361313039393666653433343933383266
          303861326631653962666533383663616539 
- hosts: "{{ hostvars['localhost']['remote_ip'] }}"
  remote_user: core
  roles:
    - role: motioncore_podman
      vars:
        motioncore_ip: "{{ hostvars['localhost']['remote_ip'] }}"
        ansible_become_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39343038313763373539336338383332366437383138346564623531393532366430363162666337
          6432613236386662356661663635313962613138656263310a356463643262633631323430373464
          66326439333439333031383033636264326263623465323264343237323832393434313534313365
          3432376438383332640a616335653334663762356664316135336566323531653938666432343839
          36343365313861306538336264613139333832633061333865373539386433623765
- hosts: "{{ hostvars['localhost']['remote_ip'] }}"
  remote_user: core
  become: yes
  roles:
    - role: devsec.hardening.os_hardening
      vars:
        os_auditd_enabled: false
        os_immutable_fs: true
        ansible_become_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39343038313763373539336338383332366437383138346564623531393532366430363162666337
          6432613236386662356661663635313962613138656263310a356463643262633631323430373464
          66326439333439333031383033636264326263623465323264343237323832393434313534313365
          3432376438383332640a616335653334663762356664316135336566323531653938666432343839
          36343365313861306538336264613139333832633061333865373539386433623765
- hosts: "{{ hostvars['localhost']['remote_ip'] }}"
  remote_user: core
  become: yes
  roles:
    - devsec.hardening.ssh_hardening
- hosts: "{{ hostvars['localhost']['remote_ip'] }}"
  remote_user: core
  become: yes
  tasks: # the tasks are specific to the "{{ hostvars['localhost']['remote_ip'] }}"_podman role.
    - name: Remove python
      become: true
      become_user: root
      community.general.rpm_ostree_pkg:
        name: "{{ ansible_required_packages }}"
        state: absent
      delegate_to: "{{ remote_ip }}"
    # - name: Set motion_user shell
    #   become: true
    #   become_user: root
    #   ansible.builtin.shell:
    #     cmd: sudo usermod motion_user -s /sbin/nologin
    #   delegate_to: "{{ remote_ip }}"
    - name: Reboot remote and wait for it to restart
      become: true
      become_user: root
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 5
        test_command: whoami
      delegate_to: "{{ remote_ip }}"

# # set remote_ip in vars/main.yaml and run following command for non interactive run
# # if you know what the ip address will be and want to avoid ssh_known check (insecure!)
# # ansible-playbook "{{ hostvars['localhost']['remote_ip'] }}"_pb.yaml --ask-become-pass --ssh-common-args='-o StrictHostKeyChecking=no'